---
title: "HW_6"
author: "Binyam Yilma"
output: github_document
---


```{r, include = FALSE}
library(tidyverse)
library(readr)
library(readxl)
library(purrr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
 ggplot2.continous.colour = "viridis",
 ggplot2.continous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Import & Filter Data
```{r, message=F}

homicide_df = 
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1,
    ),
    victim_age = as.numeric(victim_age)
  ) %>% 
  filter(!city_state %in% c("Tulsa_AL", "Dallas_TX", "Phoenix_AZ","Kansas City_MO"))  %>% 
  filter(victim_race %in% c("Black", "White")) %>% 
  filter(victim_sex %in% c("Male", "Female")) %>%  
  select(city_state, resolution, victim_age, victim_race, victim_sex)


```

####  Fit a logistic regression in Baltimore_MD
```{r}

baltimore_logitstic = homicide_df %>% 
  filter(city_state == "Baltimore_MD") %>% 
glm(resolution ~ victim_age + victim_sex + victim_race, family = binomial() , data = .) %>%
  broom::tidy() %>% 
  mutate(
    odds_ratio = exp(estimate),
    ci_lower =  exp(estimate - 1.96 * std.error),
    ci_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, odds_ratio, starts_with("CI")) %>% 
  knitr::kable(digits = 3)

```

####  Fit a logistic regression on all the cities
```{r}
models_results = homicide_df %>% 
  mutate(victim_race = fct_relevel(victim_race, "White")) %>% #reordering to compare black victims to white victims
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~ glm(resolution ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    odds_ratio = exp(estimate),
    ci_lower =  exp(estimate - 1.96 * std.error),
    ci_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, odds_ratio, starts_with("CI"))
```


#### Plot the estimated Odds Ratios and CIs for each city
```{r, fig.width=8}
models_results %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, odds_ratio)) %>% 
  ggplot(aes(x = city_state, y = odds_ratio)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper)) +
 theme(axis.text.x = element_text(angle = 60, vjust = 1.0, hjust = 1), legend.position = "none") + 
 geom_hline(yintercept=1, linetype="dashed", color = "red", size=0.5) +
  labs(
    title = "Odds Ratio of case Resolution Status, by City",
    subtitle  = "Comparing whether a homicide case is resolved for male Black victims to White victims, by City",
    x = "Odds Ratio",
    y = "City-States"
  )  
```

The estimated odds of a homicide case being resolved for male Black victims compared to the estimated odds of a homicide case being resolved for White victims is lowest is New York City, NY (with evidence of statistical significance); and highest in Albuquerque New Mexico, although this is not statistical significant. The former observation means that in New York City (as well as Baton Rouge, Louisiana; Omaha, Nebraska; Chicago, Illinois, and others whose Odds Ratio & and their 95% confidence interval is well below the dashed red line), if the homicide victims are Black, the likelihood that that case will be resolved is lower than if they were a white victim. However, this observation doesn't hold true in Boston, MA, Tampa, Florida, Atlanta, Georgia and other city-states whose odds ration and 95% confidence interval either crosses or is above the null value of odds ratio = 1 (indicated by the dashed red line.)


## Problem 2

```{r}

```

